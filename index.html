<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>A.B Electronic Shop</title>
  <style>
    /* احتفظ بنفس الـ CSS من قبل */
  </style>
</head>
<body>
  <!-- الهيكل HTML كما في السابق -->
  <div class="top-bar">…</div>
  <h1>A.B Electronic Shop</h1>
  <div id="add-product-form">…</div>
  <div class="container" id="products-container"></div>
  <footer>…</footer>

  <!-- الآن نستخدم سكربت من نوع module لاستيراد الـ SDK -->
  <script type="module">
    // استيراد الدوال المطلوبة من Firebase SDK
    import { initializeApp }         from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } 
                                      from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } 
                                      from "https://www.gstatic.com/firebasejs/9.21.0/firebase-storage.js";
    // إذا أردت تحليلات (اختياري)
    import { getAnalytics }          from "https://www.gstatic.com/firebasejs/9.21.0/firebase-analytics.js";

    // إعدادات مشروعك (استبدل بالقيم الحقيقية)
    const firebaseConfig = {
      apiKey: "AIzaSyAAEiYmVQ-tq34uHI0AFPOOcw_Ow4v_j30",
      authDomain: "abelectronic-e8ee9.firebaseapp.com",
      projectId: "abelectronic-e8ee9",
      storageBucket: "abelectronic-e8ee9.appspot.com",
      messagingSenderId: "740876799433",
      appId: "1:740876799433:web:4c582934bf9f8fe4792c18",
      measurementId: "G-FY5XTH5376"
    };

    // تهيئة Firebase
    const app       = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);             // اختياري
    const db        = getFirestore(app);
    const storage   = getStorage(app);

    // === المتغيرات والعناصر من DOM ===
    const ADMIN_PASS = atob("SGVsbG9AV29ybGQ5MA==");
    let isAdmin = false;
    const loginBtn = document.getElementById('login-btn');
    const addBtn   = document.getElementById('add-product-btn');
    const form     = document.getElementById('add-product-form');
    const saveBtn  = document.getElementById('save-product');
    const imgInput = document.getElementById('img-file');
    const container= document.getElementById('products-container');
    let products = [];

    function createMessage(name, price, qty) {
      const lines = ['السلام عليكم،', `أرغب في شراء المنتج: ${name}`, `السعر: ${price}`, `الكمية: ${qty}`];
      return encodeURIComponent(lines.join('\n'));
    }

    // تحميل وعرض المنتجات
    async function loadProducts() {
      const q = query(collection(db, 'products'), orderBy('createdAt', 'desc'));
      const snapshot = await getDocs(q);
      products = [];
      snapshot.forEach(docSnap => {
        products.push({ id: docSnap.id, ...docSnap.data() });
      });
      renderProducts();
    }

    function renderProducts() {
      container.innerHTML = '';
      products.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card' + (isAdmin ? ' admin' : '');
        card.innerHTML = `
          <button class="delete-btn">×</button>
          <img src="${p.img}" alt="${p.name}">
          <div class="card-content">
            <h2 class="product-name">${p.name}</h2>
            <p class="product-desc">${p.desc}</p>
            <div class="product-price">السعر: ${p.price}</div>
            <div class="action-row">
              <input type="number" min="1" value="1" class="quantity-input">
              <a class="buy-button" target="_blank">شراء عبر واتساب</a>
            </div>
          </div>`;
        // إعداد روابط الشراء
        const qtyInput = card.querySelector('.quantity-input');
        const buyLink  = card.querySelector('.buy-button');
        const updateLink = () => {
          const msg = createMessage(p.name, p.price, qtyInput.value);
          buyLink.href = `https://wa.me/${p.wa}?text=${msg}`;
        };
        qtyInput.addEventListener('input', updateLink);
        updateLink();
        // زر الحذف (أدمن فقط)
        card.querySelector('.delete-btn').addEventListener('click', async () => {
          // حذف الصورة من Storage (اختياري)
          // const imgRef = ref(storage, p.imgPath);
          // await deleteObject(imgRef);
          // حذف المستند
          await deleteDoc(doc(db, 'products', p.id));
          loadProducts();
        });
        container.appendChild(card);
      });
      updateUI();
    }

    function updateUI() {
      loginBtn.textContent = isAdmin ? 'تسجيل خروج' : 'تسجيل دخول';
      addBtn.style.display = isAdmin ? 'inline-block' : 'none';
      form.style.display   = 'none';
      document.querySelectorAll('.card').forEach(c => c.classList.toggle('admin', isAdmin));
    }

    // تسجيل دخول/خروج الأدمن
    loginBtn.addEventListener('click', () => {
      if (!isAdmin) {
        const pass = prompt('يرجى إدخال كلمة مرور المدير:');
        if (pass === ADMIN_PASS) { isAdmin = true; alert('تم تسجيل الدخول كأدمن!'); }
        else alert('كلمة المرور غير صحيحة.');
      } else {
        isAdmin = false;
        alert('تم تسجيل الخروج.');
      }
      updateUI();
    });

    // عرض/إخفاء نموذج إضافة المنتج
    addBtn.addEventListener('click', () => {
      form.style.display = form.style.display === 'block' ? 'none' : 'block';
    });

    // إضافة/حفظ المنتج
    saveBtn.addEventListener('click', async () => {
      const file = imgInput.files[0];
      const name = document.getElementById('prod-name').value.trim();
      const desc = document.getElementById('prod-desc').value.trim();
      const price= document.getElementById('prod-price').value.trim();
      const wa   = document.getElementById('whatsapp-number').value.trim();
      if (!file || !name || !desc || !price || !wa) {
        alert('يرجى تعبئة جميع الحقول.');
        return;
      }
      // رفع الصورة
      const imgRef = ref(storage, `products/${Date.now()}_${file.name}`);
      const snapshot = await uploadBytes(imgRef, file);
      const imgURL   = await getDownloadURL(snapshot.ref);
      // حفظ بيانات المنتج مع مسار الصورة (لو احتجت لحذفها لاحقاً)
      await addDoc(collection(db, 'products'), {
        img,             // للألوان القديمة حافظت على المفتاح img
        img: imgURL,
        name,
        desc,
        price,
        wa,
        createdAt: new Date()
      });
      alert('تم إضافة المنتج بنجاح!');
      form.reset();
      loadProducts();
    });

    // تحميل المنتجات عند فتح الصفحة
    loadProducts();
  </script>
</body>
</html>
