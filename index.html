<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.B Electronic Shop</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Cairo', sans-serif;
            background: #f5f5f5;
            color: #333;
            direction: rtl;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .top-bar {
            background: #ffffff;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .top-bar img {
            height: 50px;
        }
        .top-bar .buttons {
            display: flex;
            gap: 10px;
        }
        .top-bar button {
            padding: 8px 16px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }
        .top-bar button#add-product-btn {
            display: none;
        }
        .site-title {
            text-align: center;
            font-size: 2.2em;
            font-weight: bold;
            margin: 20px 0;
            color: #000;
        }
        .container {
            flex: 1;
            max-width: 1200px;
            margin: auto;
            padding: 0 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px,1fr));
            gap: 20px;
        }
        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform .2s;
            position: relative;
        }
        .card:hover { transform: translateY(-5px); }
        .card img { width:100%; height:200px; object-fit:cover; }
        .card-content { padding:15px; flex:1; }
        .product-name { font-size:1.2em; margin:0 0 10px; }
        .product-desc { font-size:.95em; margin:0 0 15px; line-height:1.4; color:#555; }
        .product-price { font-size:1.1em; font-weight:bold; margin-bottom:15px; color:#2c3e50; }
        .buy-button {
            text-decoration: none;
            display: inline-block;
            text-align: center;
            padding: 10px 20px;
            border-radius: 6px;
            background: #25d366;
            color: #fff;
            font-weight: bold;
            transition: background .2s;
        }
        .buy-button:hover { background: #1da851; }
        #add-product-form {
            display: none;
            max-width: 400px;
            margin: 20px auto;
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #add-product-form input,
        #add-product-form textarea,
        #add-product-form button {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: .95em;
        }
        #add-product-form button {
            background: #28a745;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        #add-product-form button:hover {
            background: #218838;
        }
        .delete-btn {
            display: none;
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,.6);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 16px;
            line-height: 20px;
            cursor: pointer;
        }
        .card.admin .delete-btn { display: block; }
        footer {
            background: #f1f1f1;
            padding: 15px;
            text-align: center;
            font-size: .9em;
        }
        .social-buttons { margin-top: 10px; }
        .social-button {
            margin: 0 5px;
            text-decoration: none;
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            background: #4267B2;
            color: #fff;
            font-size: .9em;
        }
        .social-button.youtube { background: #FF0000; }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
        }
        @media(max-width:600px){
            .site-title { font-size: 1.6em; }
            #add-product-form { width: 90%; }
            .top-bar { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <img src="logo.jpeg" alt="شعار الموقع">
        <div class="buttons">
            <button id="login-btn">تسجيل دخول</button>
            <button id="add-product-btn">إضافة منتج</button>
        </div>
    </div>

    <div class="site-title">A.B Electronic Shop</div>

    <div id="add-product-form">
        <h2 style="text-align:center;">أضف منتجاً جديداً</h2>
        <input type="file" id="img-file" accept="image/*" required>
        <input type="text" id="prod-name" placeholder="اسم المنتج" required>
        <textarea id="prod-desc" rows="3" placeholder="وصف المنتج" required></textarea>
        <input type="text" id="prod-price" placeholder="السعر (مثال: 200 ج.م)" required>
        <input type="text" id="whatsapp-number" placeholder="رقم واتساب دولي (مثال: 201234567890)" required>
        <button id="save-product">حفظ المنتج</button>
    </div>

    <div class="container" id="products-container">
        <div class="loading">جاري تحميل المنتجات...</div>
    </div>

    <footer>
        &copy; 2025 جميع الحقوق محفوظة
        <div class="social-buttons">
            <a href="https://facebook.com/YourPage" target="_blank" class="social-button">فيسبوك</a>
            <a href="https://youtube.com/YourChannel" target="_blank" class="social-button youtube">يوتيوب</a>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, push } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAEiYmVQ-tq34uHI0AFPOOcw_Ow4v_j30",
            authDomain: "abelectronic-e8ee9.firebaseapp.com",
            databaseURL: "https://abelectronic-e8ee9-default-rtdb.firebaseio.com",
            projectId: "abelectronic-e8ee9",
            storageBucket: "abelectronic-e8ee9.appspot.com",
            messagingSenderId: "740876799433",
            appId: "1:740876799433:web:4c582934bf9f8fe4792c18",
            measurementId: "G-FY5XTH5376"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);

        window.firebaseApp = {
            db: database,
            storage: storage,
            dbRef: ref,
            dbSet: set,
            dbOnValue: onValue,
            dbRemove: remove,
            dbPush: push,
            storageRef: storageRef,
            uploadBytes: uploadBytes,
            getDownloadURL: getDownloadURL
        };
    </script>

    <script>
        const ADMIN_PASS = atob("SGVsbG9AV29ybGQ5MA==");
        let isAdmin = false;
        const loginBtn = document.getElementById('login-btn');
        const addBtn = document.getElementById('add-product-btn');
        const form = document.getElementById('add-product-form');
        const saveBtn = document.getElementById('save-product');
        const imgInput = document.getElementById('img-file');
        const container = document.getElementById('products-container');
        
        let products = [];

        function createMessage(name, price) {
            const lines = [
                'السلام عليكم،',
                `أرغب في شراء المنتج: ${name}`,
                `السعر: ${price}`,
                'الكمية: 1'
            ];
            return encodeURIComponent(lines.join('\n'));
        }

        function loadProducts() {
            const productsRef = window.firebaseApp.dbRef(window.firebaseApp.db, 'products');
            window.firebaseApp.dbOnValue(productsRef, (snapshot) => {
                const data = snapshot.val();
                products = data ? Object.values(data) : [];
                renderProducts();
            });
        }

        function renderProducts() {
            container.innerHTML = '';
            
            if (products.length === 0) {
                container.innerHTML = '<div class="loading">لا توجد منتجات متاحة حالياً</div>';
                return;
            }
            
            products.forEach((p, idx) => {
                const card = document.createElement('div');
                card.className = 'card' + (isAdmin ? ' admin' : '');
                const msgParam = createMessage(p.name, p.price);
                card.innerHTML = `
                    <button class="delete-btn">×</button>
                    <img src="${p.img}" alt="${p.name}" loading="lazy">
                    <div class="card-content">
                        <h2 class="product-name">${p.name}</h2>
                        <p class="product-desc">${p.desc}</p>
                        <div class="product-price">السعر: ${p.price}</div>
                        <a class="buy-button" href="https://wa.me/${p.wa}?text=${msgParam}" target="_blank">شراء عبر واتساب</a>
                    </div>`;
                
                card.querySelector('.delete-btn').addEventListener('click', async () => {
                    if (isAdmin && confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                        try {
                            // الحصول على معرف المنتج لحذفه
                            const productId = Object.keys(snapshot.val())[idx];
                            const productRef = window.firebaseApp.dbRef(
                                window.firebaseApp.db, 
                                `products/${productId}`
                            );
                            await window.firebaseApp.dbRemove(productRef);
                            alert('تم حذف المنتج بنجاح');
                        } catch (error) {
                            console.error('Error deleting product:', error);
                            alert('حدث خطأ أثناء حذف المنتج: ' + error.message);
                        }
                    }
                });
                
                container.appendChild(card);
            });
        }

        function updateUI() {
            loginBtn.textContent = isAdmin ? 'تسجيل خروج' : 'تسجيل دخول';
            addBtn.style.display = isAdmin ? 'inline-block' : 'none';
            form.style.display = 'none';
            document.querySelectorAll('.card').forEach(c => c.classList.toggle('admin', isAdmin));
        }

        loginBtn.addEventListener('click', () => {
            if (!isAdmin) {
                const pass = prompt('يرجى إدخال كلمة مرور المدير:');
                if (pass === ADMIN_PASS) {
                    isAdmin = true;
                    alert('تم تسجيل الدخول كأدمن!');
                } else if (pass !== null) {
                    alert('كلمة المرور غير صحيحة.');
                }
            } else {
                isAdmin = false;
                alert('تم تسجيل الخروج.');
            }
            updateUI();
        });

        addBtn.addEventListener('click', () => {
            form.style.display = form.style.display === 'block' ? 'none' : 'block';
        });

        saveBtn.addEventListener('click', async () => {
            const file = imgInput.files[0];
            const name = document.getElementById('prod-name').value.trim();
            const desc = document.getElementById('prod-desc').value.trim();
            const price = document.getElementById('prod-price').value.trim();
            const wa = document.getElementById('whatsapp-number').value.trim();
            
            if (!file || !name || !desc || !price || !wa) {
                alert('يرجى تعبئة جميع الحقول.');
                return;
            }

            if (!/^20\d{9,}$/.test(wa)) {
                alert('يرجى إدخال رقم واتساب مصري صحيح (يبدأ بـ 20 ويتكون من 11 رقمًا على الأقل)');
                return;
            }

            saveBtn.disabled = true;
            saveBtn.textContent = 'جارٍ الحفظ...';

            try {
                console.log('بدء عملية الحفظ...');
                
                // 1. رفع الصورة إلى Storage
                console.log('جاري رفع الصورة...');
                const fileRef = window.firebaseApp.storageRef(
                    window.firebaseApp.storage, 
                    `products/${Date.now()}_${file.name}`
                );
                await window.firebaseApp.uploadBytes(fileRef, file);
                const imgUrl = await window.firebaseApp.getDownloadURL(fileRef);
                console.log('تم رفع الصورة بنجاح:', imgUrl);

                // 2. إنشاء كائن المنتج
                const newProduct = {
                    img: imgUrl,
                    name: name,
                    desc: desc,
                    price: price,
                    wa: wa,
                    createdAt: Date.now()
                };

                // 3. إنشاء مرجع جديد في قاعدة البيانات
                const newProductRef = window.firebaseApp.dbPush(
                    window.firebaseApp.dbRef(window.firebaseApp.db, 'products')
                );
                
                // 4. حفظ المنتج في قاعدة البيانات
                console.log('جاري حفظ المنتج في قاعدة البيانات...');
                await window.firebaseApp.dbSet(newProductRef, newProduct);
                console.log('تم حفظ المنتج بنجاح');

                // 5. إعادة تعيين الحقول
                imgInput.value = '';
                document.getElementById('prod-name').value = '';
                document.getElementById('prod-desc').value = '';
                document.getElementById('prod-price').value = '';
                document.getElementById('whatsapp-number').value = '';
                
                // 6. إظهار رسالة النجاح وإخفاء النموذج
                alert('تم إضافة المنتج بنجاح!');
                form.style.display = 'none';
            } catch (error) {
                console.error('حدث خطأ أثناء حفظ المنتج:', error);
                alert(`حدث خطأ أثناء حفظ المنتج: ${error.message}`);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'حفظ المنتج';
            }
        });

        // تحميل المنتجات عند بدء التشغيل
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            updateUI();
        });
    </script>
</body>
</html>